 "homefeedcenter_popup": {
                    "hfopt_filter": ["Filtering", "Put a search text to filter your posts.<br>You can use \"|\" character to set diferent searches.<br>Example:Build|operation|mission."],
                    "hfopt_grouping": ["Filtering", "Select a group of posts to show."],
                    "hfopt_dogotowar": ["Helping", "Check it to help in published wars.<br>Click to open more options."],
                    "hfopt_dogivesocialhelp": ["Helping", "Check it to help in published jobs.<br>Click to open selection menu."],
                    "hfopt_dosocialmissions": ["Helping", "Check it to join in operations.<br>Click to open more options."],
                    "hfopt_doclaimbonusandreward": ["Helping", "Check it to claim/collect all bonuses and rewards published.<br>Click to open selection Menu."],
                    "hfopt_docollectloot": ["Helping", "Check it to collect published loots (actually this option is unnecesary).<br>Click to open search filter. One entry per line."],
                    "hfopt_dopropertyhelp": ["Helping", "Check it to help sending property parts.<br>Click to open selection menu."],
                    "hfopt_dogetboost": ["Helping", "Check it to help in levelup bonuses."],
                    "hfopt_dosendenergyandphones": ["Helping", "Check it to help sending rob phones and energy packs."],
                    "hfopt_doacceptgiftevent": ["Helping", "Check it to help in gift events."],
                    "hfopt_dohitlistbounty": ["Helping", "Check it to help in hitlist bounties.<br>Click to open selection by filter options."],
                    "hfopt_dosecretstash": ["Helping", "Check it to help in secret stashes.<br>Click to open selection by filter options."],
                    "hfopt_docitycrew": ["Helping", "Check it to help your friends by joining their city crew.<br>Click to open selection by filter options."],
                    "skiptext_givesocialhelp": ["Edit Skip Action", "Set the text returned by the server after collect the selected feed when you reached the limit for this feed to skip it."],
                    "skiptext_claimbonusandreward": ["Edit Skip Action", "Set the text returned by the server after collect the selected feed when you reached the limit for this feed to skip it."],
                    "skiptext_propertyhelp": ["Edit Skip Action", "Set the text returned by the server after collect the selected feed when you reached the limit for this feed to skip it."],
                    "hfopt_autoclose": ["General", "If checked, the help options you click \"accept\" the link will be autoclosed after a few seconds."],
                    "hfopt_feedslimit": ["General", "Set here the limit of posts you want to load when using \"AutoHelp\"."],
                    "hfopt_maxloglength": ["General", "Set here the maximum number of log entries when using \"AutoHelp\"."],
                    "hfopt_helpdelay": ["General", "Set here how much time you want to wait between helping."],
                    "hfopt_refreshdelay": ["General", "Set here how much time you want to wait before refreshing your home posts."],
                    "hfopt_useuserfilter": ["User Filter", "Enable/disable user filter."],
                    "hfopt_userfilteraction": ["User Filter", "Select how you want to use the filter."],
                    "hfopt_userfilter": ["Filters", "Click \"EDIT\" to add/remove friends to filter the feeds you want to see adn help in Home Feed Center."],
                    "hfopt_waruseminattack": ["War help", "Check it if you want to collect only those items with more than the specified attack."],
                    "hfopt_warminattack": ["War help", "Set the minimum war reward item attack need to help in a war."],
                    "hfopt_warusemindefense": ["War help", "Check it if you want to collect only those items with more than the specified defense."],
                    "hfopt_warmindefense": ["War help", "Set the minimum war reward item defense need to help in a war."],
                    "hfopt_warusenamefilter": ["War help", "Check it to use war reward item's name to filter wars. If you check it, you should uncheck minimal attack/defense options."],
                    "hfopt_warnamefilter": ["War help", "Add war reward item's names separated by commas or \"|\" character.<br>Example:Paraglider|Sharksaw|emu Or Paraglider,Sharksaw,Emu."],
                    "warloot_data": ["War Loot", "Secundary loot is used to filter those wars that you would like to help for your mafia but giving you no loot.<br><br>Click \"TOGGLE\" to enable/disable all war secundary loot."],
                    "warlootlimited_data": ["War Loot", "It's your desired war loot.<br>You will help in wars for this loot (if enabled) until you've reached the 5/5 limit.<br>If you've reached to the 5/5 limit or you disables it, will check your secundary war loot to determinate if you should help or not."],
                    "warloot_name": ["War Loot", "Set the name of the loot you want to collect.<br>(Asterisk) \"*\" means anything."],
                    "warloot_att": ["War Loot", "Set the minimal attack a loot should have to help in the war.<br>\"0\" means anything."],
                    "warloot_def": ["War Loot", "Set the minimal defense a loot should have to help in the war.<br>\"0\" means anything."],
                    "warloot_enabled": ["War Loot", "Enable/Disable this loot."],
                    "hfopt_joinmission": ["Operations", "Select the slot type where you want to join."],
                    "hfopt_joinmissionafter": ["Operations", "If the previous slot type are not available, select a second slot type to join."],
                    "hfopt_maxfreeslots": ["Operations", "Select the maximum amount of free slots to join in an operation."],
                    "hfopt_opusenamefilter": ["Operations", "Check to filter operations by name.<br>You will try to join only the operations that match the filter name."],
                    "hfopt_opnamefilter": ["Operations", "Add operatons names separated by \"|\" character.<br>Example:<br>Fix The Tripple Crown|Steal Government Research"],
                    "hfopt_dtlootpriority": ["Daily Take", "Enter the EXACT name of the items you want ADDON to retrieve.<br>Put one item on each line in the order you want to retrieve them (the most important item first).<br>HINT: You can get the name of the item by hovering over it in the Daily Take window."],
                    "hfopt_dtcheckminatkdef": ["Daily Take", "Check to retrieve fight loot if there is nothing that is on your Priority List available.<br>You can specify a minimum attack and defense.<br>If there is nothing that meets your specifications, the daily take will be ignored."],
                    "hfopt_dtminattack": ["Daily Take", "Set the minimal attack value for the fight loot."],
                    "hfopt_dtmindefense": ["Daily Take", "Set the minimal defense value for the fight loot."],
                    "hfopt_dodailytake": ["Helping", "Check it to help in Daily Takes.<br>Click to open more options."],
                    "hfopt_fblistfilteron": ["Filters", "Enable or Disable Facebook Friends list Filter.<br><br>Click \"EDIT\" to show a list of your Facebook friends list which you can select to filter the feeds you want to see adn help in Home Feed Center."],
                    "hfopt_fblistfilter": ["Filters", "Click \"EDIT\" to show a list of your Facebook friends list which you can select to filter the feeds you want to see adn help in Home Feed Center."],
                    "hfopt_userfilteron": ["Filters", "Enable or Disable Friends Filter.<br><br>Click \"EDIT\" to add/remove friends to filter the feeds you want to see adn help in Home Feed Center."],
                    "hfopt_warlootsecundarylimit": ["War Loot", "Used to colelct all secundary llot one time.<br><br>Once the loot has been collected, it will turn in OFF."],
                    "action_skipif": ["Skip Check", "Used to Skip a feed when the result text from the server match the criteria."],
                    "action_fail": ["Fail Check", "Used to send a feed to the fail log when you was not able to collect it when the result text from the server match the criteria."]
 
    // Initialize
    options.load(Initialize);
}
// ==Script==
// @id        HomeFeedCenter.js
// @author    Dakam
// @requires  MWAddon.js
// ==Script==
/**
 * Set configuration.
 */
UserConfig.create('hfopt', {
    // exclude some settings when exporting.
    _excludedToExport: ['collectedStreams', 'lastPostTime'],
    
    actions                    : {'skipif':new Object(),'fail':new Object()},
    maxLogLength               : 50,
    lastPostTime               : 0,
    collectedStreams           : new Array(),
    feedsLimit                 : 100,
    fbListFilterOn             : false,
    fbListFilter               : new Object(),
    userFilterOn               : false,
    userFilter                 : new Object(),
    doGotoWar                  : false,
    doGiveSocialHelp           : true,
    GiveSocialHelp             : new Object(),
    doSocialMissions           : false,
    doClaimBonusAndReward      : true,
    ClaimBonusAndReward        : new Object(),
    doPropertyHelp             : true,
    PropertyHelp               : new Object(),
    doSendEnergyAndPhones      : true,
    doAcceptGiftEvent          : true,
    doCityCrew                 : true,
    doDailyTake                : true,
    helpDelay                  : 3,
    refreshDelay               : 60,
    joinMission                : 0,
    joinMissionAfter           : 0,
    diff_easy                  : false,
    diff_medium                : false,
    diff_hard                  : true,
    diff_event                 : false,
    maxFreeSlots               : 100,
    warlootLimited             : {'id':'limited', 'enabled':true, 'name':'*', 'att':0, 'def':0},
    warLimitCount              : 0,
    warloot                    : new Object(),
    warlootSecundaryLimit      : false,
    opUseNameFilter            : false, 
    opNameFilter               : '',
    dtCheckMinAtkDef           : false, 
    dtMinAttack                : 30,
    dtMinDefense               : 30,
    dtLootPriority             : 'Attack Point\nDefense Point'
});

var UserStreams = {
    content: new Array(),
    /**
     * Add a new user defined stream.
     * @param {String} id
     * @param {Object} action
     */
    add: function(id, action) {
        UserStreams.content.push({
            'id': id,
            'action': action
        });
    }
};
/**
 * Get feed stories and autohelp all
 */
function HomeFeedCenter() {
    if (facebook.initialized !== true) {
        showHelpPopup({
            icon: 'error',
            title: 'You cant use Home Feed Center',
            message: 'Home Feed Center requires Facebook Api and it\'s not loaded.'
        });
        return;
    }
    const ERROR_BAD_RESPONSE = 'Unexpected server response, check this stream manually.';
    var messageTimer = new TimerMessage('#auto_feed_helper_messages');
    var cancel_process = false;
    /** @type {CSStreamCollection} */ var feedStream;
    /** @type {CSActionCollection} */ var Actions;
    var options = UserConfig.hfopt;
    
    // popup
    var popupElt = new PopupObject('homefeedcenter_popup', {
        type: 'main',
        title: 'HOME FEED CENTER',
        onclose: function() {
            cancel_process = true;
            httpAjaxStopRequests();
            messageTimer.clear();
            options.fromDomElements();
            options.save();
        }
    });

    var groupNames = {
        'none'                    : 'General',
        'doGotoWar'               : 'Go to War',
        'doGiveSocialHelp'        : 'Give Social Help',
        'doDailyTake'             : 'Daily Take',
        'doSocialMissions'        : 'Operations',
        'doClaimBonusAndReward'   : 'Claim Bonus And Reward',
        'doPropertyHelp'          : 'Property Help',
        'doSendEnergyAndPhones'   : 'Send Energy And Phones',
        'doCityCrew'              : 'City Crew'
    };

    /**
     * @constructor
     * @param {Object} feed
     * @return {CSStream}
     */
    var CSStream = function(feed) {
        var me = this;
        var action;
        try {
	        if (!feed.attachment.href) {
	            feed.attachment.href = feed.attachment.media[0].href;
	        }
	        if (!feed.attachment.href) {
	            throw Error('Stream: Invalid href');
	        }
            me.url      = Util.uSplit(feed.attachment.href);
            me.id       = me.url.next_controller + '_' + me.url.next_action;
            me.url      = toInternalUrl(me.url);
            me.action   = Actions.get(me.id, me.url);
            me.isValid  = true;
            me.feed     = feed;
            me.user_id  = feed.source_id;
            me.isNew    = (feed.created_time > options.lastPostTime);
            me.gid      = (me.action ? me.action.group : '')
        }
        catch(err) {
            Logger.error(err);
            me.id = 'Unknow';
            me.isValid = false;
        }
        /**
         * Return true if this was collected.
         */
        me.isCollected = function() {
            var arr = options.collectedStreams;
            if (Util.isArray(arr)) {
                return arr.indexOf(feed.post_id) !== -1;
            } else {
                options.set('collectedStreams', new Array());
                options.save();
            }
            return false;
        };
        /**
         * Set this feed as collected.
         */
        me.collected = function() {
            var arr = options.collectedStreams;
            if (!Util.isArray(arr)) {
                options.set('collectedStreams', (arr = new Array()));
            }
            else if (arr.length > 199) {
                arr = arr.splice(0, 1);
            }
            arr.push(feed.post_id);
            options.save();
        };

        return this;
    };
    /**
     * Create a new Stream collection.
     * @param {Object} feeds
     * @param {Boolean} bOnlyNewFeeds
     * @return {CSStreamCollection}
     */
    var CSStreamCollection = function(feeds, bOnlyNewFeeds) {
        var nLastTime = options.get('lastPostTime');
        var nNewLastTime = nLastTime;
        var streams = new Array();

        /**
         * @param {Number} index
         * @return {CSStream}
         */
        this.get = function(index) {
            return streams[index];
        };
        /** @return {CSStream} */
        this.shift = function() {
            return streams.shift();
        };
        /** @param {Number} index */
        this.remove = function(index) {
            streams[index] = null;
        };
        /** @return {Number} */
        this.length = function() {
            var len = 0;
            for (var i = 0; i < streams.length; i++) {
                if (Util.isSet(streams[i])) { len++; }
            }
            return len;
        };
        /**
         * Loops through all streams. 
         * @param {Function} callback
         */
        this.each = function(callback) {
            Util.each(streams, callback);
        };
        /**
         * Split stream array to the new quantity
         */
        this.slice = function(amount) {
            streams = streams.slice(0, amount);
        }

        Util.each(feeds, function(n, feed) {
            if (feed && feed.created_time) {
                var me  = parseFloat(facebook.session.uid);
                var sid = parseFloat(feed.source_id);
                var tid = feed.target_id ? parseFloat(feed.target_id) : null;

                if ( feed.created_time > nNewLastTime ) {
                    nNewLastTime = feed.created_time;
                }

                if ( sid !== me && (tid == null || tid == me) ) {
                    var strm = new CSStream(feed);
                    if ( strm.isValid && (bOnlyNewFeeds !== true || strm.isNew) ) {
                        streams.push(strm);
                    }
                }
            }
        });

        options.set('lastPostTime',nNewLastTime);
        options.save();

        /** @type Number   */
        this.lastTime = nNewLastTime;

        return this;
    };
    /**
     * @constructor
     * @param {Object} params
     * @return {CSAction}
     */
    var CSAction = function(params) {
        /** @type String   */ this.name      = params.name;
        /** @type Number   */ this.group     = params.group;
        /** @type Object   */ this.next      = params.next;
        /** @type String   */ this.skipif    = params.skipif;
        /** @type String   */ this.fail      = params.fail;
        return this;
    };
    /**
     * @constructor
     * @return {CSActionCollection}
     */
    var CSActionCollection = function() {
        var actions = new Object();
        /**
         * @param {String} id
         * @param {Object} params
         */
        this.add = function(id, params) {
            actions[id] = params;
        };
        /** @return {CSAction, Array} */
        this.get = function(id, url) {
            var action = actions[id];
            if (action && action.match && Util.isString(url)) {
                Util.each(action.match, function(test, a) {
                    if (url.indexOf(test) > -1) {
                        a.skipif = action.skipif;
                        a.group = action.group;
                        a.fail = action.fail;
                        a.next = action.next;
                        action = a;
                        return false;
                    }
                });
            }
            return action;
        };
        /** @param {Function} callback */
        this.each = function(callback) {
            Util.each(actions, callback);
        };
        return this;
    };
    /**
     * @constructor
     * @param {Object} element
     * @return {CSDailyTakeLoot}
     */
    var CSDailyTakeLoot = function(element) {
        var expr = /do_ajax\('popup_fodder','(remote\/html_server.php[^']+)/i;
        var $pic = $('div:first img', element);
        this.pic      = $pic.attr('src');
        this.url      = Util.doRgx(expr, $('.collectbutton a', element).attr('onclick')).$1;
        this.attack   = parseInt($('.attack', element).text()||0);
        this.defense  = parseInt($('.defense', element).text()||0);
        this.name     = $pic.attr('title');
        return this;
    };
    var CSDailyTakeLootCollection = function() {
        var Items = new Array();
        /**
         * @param {CSDailyTakeLoot} loot
         */
        this.add = function(loot) {
            if (loot && loot.url) {
                Items.push(loot);
            }
        };
        this.length = function() {
            return Items.length;
        };
        /**
         * @param {Number} index
         */
        this.get = function(index) {
            return Items[index];
        };
        /**
         * Loops through all loot items and return the matched item.
         * @param {String} name
         * @return {CSDailyTakeLoot}
         */
        this.getByName = function(name) {
            var matched;
            if (Util.isString(name) && name.length > 0) {
                var expr = new RegExp(name, 'i');
                Util.each(Items, function(index,loot) {
                    if (expr.test(loot.name)) {
                        matched = loot;
                        return false;
                    }
                });
            }
            return matched;
        };
        /**
         * Loops through all loot items and return the matched item.
         * @param {Number} attack
         * @param {Number} defense
         * @return {CSDailyTakeLoot}
         */
        this.getByStats = function(attack, defense) {
            var matched;
            if (Util.isString(name) && name.length > 0) {
                Util.each(Items, function(index,loot) {
                    if (loot.attack >= attack || loot.defense >= defense) {
                        matched = loot;
                        return false;
                    }
                });
            }
            return matched;
        };        
        /**
         * Get all items names.
         */
        this.names = function() {
            var names = new Array();
            Util.each(Items, function(index,loot) {
                names.push(loot.name);
            });
            return names.join(', ');
        };
        /**
         * Loops through all loot items.
         * @param {Object} callback
         */
        this.each = function(callback) {
            Util.each(Items, callback);
        };
        return this;
    };

    // EVENTS
    var Events = {
        toggleWarloot: function() {
            Util.each(options.warloot, function(id, data) {
                data.enabled = (data.enabled !== true);
            });
            updateWarLoot();
            return false;
        },
        selectHelp: function() {
            var me = $(this), $ul = $('#logList');
            var p = me.position(), w = me.width();
            var t = $ul.position().top;
            var h = t + $ul.height() - me.outerHeight();
            me.addClass('selected').css({'top':Math.max(t, Math.min(h, p.top)), 'width':w});
        },
        unselectHelp: function() {
            $(this).removeAttr('style').removeClass('selected');
        },
        likeFeed_click: function() {
            var me = $(this);
            me.unbind().css('opacity',0.5);
            facebook.likeAdd(me.attr('postid'),function(success) {
                if (success === true) {
                    me.replaceWith(Util.setColor('Liked!','yellow')).css('opacity',1);
                } else {
                    me.replaceWith(Util.setColor('Fail','red')).css('opacity',1);
                }
            });
            return false;
        },
        removeWarloot: function() {
            var $selection = $('#warloot_data option:selected');
            if ($selection.length > 0) {
                $selection.each(function(index,op) {
                    delete options.warloot[op.value];
                });
                options.save(updateWarLoot);
            }
            return false;
        },
        editWarloot: function() {
            var $selected = $('#warloot_data option:selected:first');
            if ($selected.length > 0) {
                showWarLootEditor();
                warLootData(options.warloot[$selected.val()]);
            }
            return false;
        },
        addWarloot: function() {
            showWarLootEditor();
            warLootData($(this).attr('limited') ? options.warlootLimited : {});
            return false;
        },
        resetLimitedWarloot: function() {
            options.warLimitCount = 0;
            options.save(updateWarLoot);
            return false;
        },
        addFblistToFilter_click: function() {
            showFBListEditor();
            return false;
        },
        addUserToFilter_click: function() {
            var added_users = new Array();
            var listElt = $('#hfopt_userfilter');
            $('option',listElt).each(function(i, e) {
                added_users.push(e.value);
            });
            showFriendsSelector(function(users) {
                if (users && users.length > 0) {
                    listElt.empty();
                    Util.each(users, function(i, user) {
                        c$('option','value:'+user.uid).text(user.name).appendTo(listElt);
                    });
                }
            }, added_users);
            return false;
        },
        clearUserFilter_click: function() {
            $('#hfopt_userfilter', popupElt.content).empty();
            return false;
        },
        clearFblistFilter_click: function() {
            $('#hfopt_fblistfilter', popupElt.content).empty();
            options.set('fbListFilter', {});
            return false;
        },
        helpFeed_click: function() {
            if ($(this).hasClass('disabled')) {
                return false;
            }
            $(this).addClass('disabled');
            var unkActionMsg = 'Unknow feed.<br>You can still help by <a href="${link}" target="_black">click here</a>.';
            var id = $(this).attr('feed');
            var $li = $('li[feed='+id+']');
            var $p = $('.body > p', $li).empty();
            var $div = $('.state_completed',$li);
            var help = feedStream.get(id);
            
            $('.state_accept, .state_completed', $li).hide();
            
            if (help && help.action && isChecked(help.action.enable)) {
                Resources.getPicture('ajax_loader','span').appendTo($p).css('padding-left',18).text('Loading...');
                doHelp(help.url, help.action, function(data, success) {
                    data = cleanResponse(data);
                    help.collected();
                    $li.addClass('collected');
                    if (success === true) {
                        addCommentFeed($div, help.feed.post_id, data);
                    }
                    completed(data);
                });
            }
            else {
                completed(Util.render(unkActionMsg,{'link':help.feed.attachment.href}));
                $li.addClass('collected');
            }
            function completed(message, callback) {
                $p.hide().html(message).fadeIn(500, function(){$div.show();});
            }
            return false
        },
        deleteFeed_click: function() {
            removeFeed( $(this).attr('feed') );
            return false
        },
        skip_click: function() {
            showDiv('control', 'panel', 500, qryAction('#status_panel','empty'));
        },
        refresh_click: function() {
            showDiv('ajaxloader', 'body');
            showDiv('status', 'panel');
            c$('div').css('padding-top',5).appendTo($('#status_panel').empty())
                     .text('Loading... wait a moment please.');
            queryFeeds(function(fs) {
                if (!Util.isArray(fs) || fs.length < 1) {
                    showErrorMessage();
                    return;
                }
                feedStream = new CSStreamCollection(fs);
                genFeedsDom();
                updateWarLoot();
                showDiv('feedlist', 'body');
                showDiv('control', 'panel', 500);
            });
        },
        cancel_click: function() {
            messageTimer.clear();
            cancel_process = true;
            options.save(Events.refresh_click);
            $('#logList, #logSkippedList').empty();
            return false;
        },
        config_click: function() {
            $('#control_panel').fadeOut(500, function() {
                $('#minipopup_overlay').fadeIn(500);
                $('#panel_container').animate({height: 280}, 'normal', function() {
                    $('#config_panel').fadeIn(500);
                });
            });
        },
        save_click: function() {
            options.fromDomElements();
            options.save();
            $('#config_panel').fadeOut(500, function() {
                $('#panel_container').animate({height:35}, 'normal', function() {
                    $('#minipopup_overlay').fadeOut(500);
                    $('#control_panel').fadeIn(500);
                });
            });
        },
        keyup: function() {
            var search = this.value;
            clearTimeout($(this).attr('timeout'));
            $(this).attr('timeout', setTimeout(function() {
                if (Util.isString(search) && search.length > 3) {
                    $('li[feed]', '#feedlist_body').each(function(index, element) {
                        if (Util.doRgxTest(search, $('.body > p',element).text())) {
                            $(element).show();
                        } else {
                            $(element).hide();
                        }
                    });
                } else {
                    $('li[feed]', '#feedlist_body').show();
                }
            }, 1000));
        },
        change: function() {
            var gid = $('option:selected', this).val();
            if (gid === 'none') {
                $('li[feed]', '#feedlist_body').show();
                return;
            }
            $('li[feed]', '#feedlist_body').hide();
            $('li[gid='+gid+']', '#feedlist_body').show();
        },
        clearall: function() {
            $('li.collected', popupElt.content).each(function(index, element) {
                removeFeed( $(element).attr('feed') );
            });
        },
        config_change: function(e) {
            var $prnt = $(this).parent();
            var name = $(this).attr('name');
            
            if (!$(e.target).hasClass('checkbox') && !$(this).hasClass('selected')) {
                $('.selected', $prnt).toggleClass('selected', false);
                $(this).toggleClass('selected', true);
                showDiv(name, 'config');
            }
            return false;
        },
        subconfig_change: function(e) {
            var $div = $(this).parent().parent();
            var name = $(this).attr('name');
            var action = Actions.get(name);
            
            if (!$(e.target).hasClass('checkbox') && !$(this).hasClass('selected')) {
                $('.selected', $div).removeClass('selected');
                $(this).addClass('selected');
                if (action) {
                    $('#action_skipif', $div).attr('name',name).val(action.skipif||'');
                    $('#action_fail',   $div).attr('name',name).val(action.fail||'');
                }
            }
            return false;
        },
        action_issue_change: function() {
            var id = $(this).attr('name');
            var type = Util.doRgx(/action_(\w+)/, this.id).$1;
            var text = this.value;
            if (!Util.isString(id) || !Util.isString(text)) { 
                return; 
            }
            if (text.length < 1) {
                delete Actions.get(id)[type];
                delete options.actions[type][id];
            }
            else if (text !== Actions.get(id)[type]) {
                options.actions[type][id] = text;
                Actions.get(id)[type] = text;
            }
        }
    };
    /**
     * Return a function to execute the defined jQuery action.
     * @param {Object} selector
     * @param {String} action
     * @param {Object} [context]
     */
    function qryAction(selector, action, context) {
        return function() {
            $(selector, context)[action]();
        };
    }
    /**
     * Open a mini-popup to edit some configurations.
     * @param {Object} content
     * @param {Function} callback
     */
    function showMiniEditor(content, callback) {
        var p = new PopupObject({
            appendTo         : $('#minipopup_content').show(),
            type             : 'help',
            autoOpen         : true,
            zIndex           : 99999,
            closeAfterClick  : true,
            hideCloseButton  : true,
            content          : content,
            buttons: [{
                label: 'Save',
                addClass: 'short green',
                onclick: callback
            },{
                label: 'Close',
                addClass: 'short red'
            }]
        });
    }
    /**
     * Show the facebook friendlist mini-editor.
     */
    function showFBListEditor() {
        loadingScreen('Loading Facebook Friend lists...');
        facebook.friendlist(function(response) {
            loadingScreen();
            if (!Util.isArray(response.data)) {
                return;
            }
            var $fl = c$('div', 'class:fb_friendlist');
            Util.each(response.data,function(index, list) {
                if (list.list_type === 'user_created') {
                    x$(list.id, list.name, 'div').appendTo($fl)
                    .toggleClass('checked', Util.isSet(options.fbListFilter[list.id]));
                }
            });
            showMiniEditor(c$('div').css('text-align', 'left')
                .append(c$('center').text('ADDING FRIENDLISTS FILTER'))
                .append($fl), 
            function() {
                options.set('fbListFilter', {});
                $('.checkbox.checked', $fl).each(function(i, e) {
                    options.fbListFilter[e.id] = $(e).text();
                });
                options.toDomElements();
                options.save();
            });
        });
    }
    /**
     * Show the war loot mini-editor.
     */
    function showWarLootEditor() {
        showMiniEditor(c$('div').css('padding-bottom', 10)
            .append(c$('center').text('ADDING WAR LOOT'))
            .append(c$('input:hidden', 'id:warloot_id'))
            .append(c$('div').css({'clear':'both','margin-top':8}))
            .append(t$('warloot_name', 'Name:', 350))
            .append(c$('div').css({'clear':'both','margin-top':8}))
            .append(n$('warloot_att', 'Attack above:', 50))
            .append(n$('warloot_def', 'Defense above:', 50))
            .append(c$('div').css({'clear':'both','margin-top':8}))
            .append(x$('warloot_enabled', 'Enabled')), 
        function() {
            var data = warLootData();
            if (data.id === 'limited') {
                options.warlootLimited = data;
            } else {
                options.warloot[data.id] = data;
            }
            options.save(updateWarLoot);
        });
    }
    /**
     * Set/Get the war loot current data.
     * @param {Object} [data]
     * @return [Object]
     */
    function warLootData(data) {
        var $content = $('#minipopup_content');
        var save = Util.isSet(data);
        data = Util.merge({
            id      : parseInt((new Date()).getTime()/1000),
            enabled : true,
            name    : '*',
            att     : 0,
            def     : 0
        }, data);
        Util.each(data, function(name, value) {
            var $el = $('#warloot_'+name, $content);
            if ($el.length > 0) {
                if ($el.is('input, select')) {
                    if (save) {
                        $el.val(value);
                    } else {
                        data[name] = $el.val();
                    }
                } else {
                    if (save) {
                        $el.toggleClass('checked',value);
                    } else {
                        data[name] = $el.hasClass('checked');
                    }
                }
            }
        });
        if (!Util.isString(data.name) || data.name.length < 1) {
            data.name = '*';
        }
        return data;
    }
    function updateWarLoot() {
        var $list = $('#warloot_data').empty();
        var text = '${enabled}: "${name}" if > "${att}/${def}".';
        var limited = options.warlootLimited;
        $('#warlimit_count').text('('+options.warLimitCount+'/5)');
        $('#warlootlimited_data').val(Util.render(text, {
            enabled: (limited.enabled?'ON':'OFF'),
            name: (limited.name==='*'?'Any':limited.name),
            att: limited.att,
            def: limited.def
        }));
        Util.each(options.warloot, function(id, data) {
            c$('option','value:'+id).appendTo($list).text(Util.render(text, {
                enabled: (data.enabled?'ON':'OFF'),
                name: (data.name==='*'?'Any':data.name),
                att: data.att,
                def: data.def
            }));
        });
    }
    
    /**
     * @param {Element, jQuery, String} selector
     * @return {String}
     */
    function getUrlFromElement(selector) {
        var obj = $(selector);

        if (!obj.length || !obj.attr)
            return '';

        var url = obj.attr('href');

        if (typeof(url) == 'string' && /https?/.test(url)) {
            return url;
        }
        return Util.doRgx(/['"](remote[^'"]*)/, obj.attr('onclick')).$1;
    }
    /**
     * @param {String} url
     * @return {String}
     */
    function toInternalUrl(params) {
        if (!Util.isSet(params)) {
            return '';
        }
        var a, b;
        var sOutUrl = 'remote/' + MW.getIntURL(params.next_controller, params.next_action);
        var unQuote = function(str) {
            return Util.doRgx(/"([^"]+)"/, str).$1 || str;
        };
        for (var uri in params) {
            if (!/next_|from|zy_track|value/.test(uri)) {
                 if (uri==='friend') {
                     sOutUrl += ('&' + uri + '=' + Util.parseNum(params[uri]));
                 } else {
                     sOutUrl += ('&' + uri + '=' + params[uri]);
                 }
            }
        }
        if ( String(params.next_params).charAt(0) === '{' ) {
	        Util.each(Util.parseParam(params.next_params), function(n, v) {
	            sOutUrl += ('&' + n + '=' + v);
	        });
        }
        if ( String(params.value).charAt(0) === '{' ) {
            Util.each(Util.parseParam(params.value), function(n, v) {
                sOutUrl += ('&' + n + '=' + v);
            });
        }

        return sOutUrl;
    }
    /**
     * @param {String} data
     * @return {String}
     */
    function cleanResponse(response) {
        if (typeof(response) !== 'string') {
            return response;
        }
        var obj = $('<div>'+ response.replace(/<div[^>]*>/g, '<div>') +'</div>');
        $('img, .sexy_button_new, .sexy_button, br, div:empty, .msg_energy_but_col, script', obj).remove();
        return obj.html();
    }
    /**
     * Add a comment button.
     * @param {Object} element
     * @param {String} post_id
     * @param {String} message
     */
    function addCommentFeed(element, post_id, message) {
        message = h$('<div>'+message+'</div>').text();
        if (!post_id || !(Util.isString(message) && message.length > 2)) { 
            return;
        }
        c$('a','href:#,class:ignore').text('Comment').appendTo(element).click(function() {
            var me = $(this);
            me.unbind().css('opacity',0.5);
            facebook.commentAdd(post_id, message, function(comment) {
                if (comment && comment.id) {
                    me.replaceWith(Util.setColor('Commented!','yellow')).css('opacity',1);
                } else {
                    me.replaceWith(Util.setColor('Fail','red')).css('opacity',1);
                }
            });
            return false;
        });
    }
    /**
     * Return true if checkbox exist and is cheched. Otherwise false.
     * @param {Object} selector
     * @param {Object} context
     * @return {Boolean}
     */
    function isChecked(selector, context) {
        if (typeof(selector) == 'undefined') {
            return true;
        }
        return $(selector, context).attr('checked');
    }
    /**
     * @return {Number}
     */
    function getRefreshDelay() {
		var refreshDelay = parseInt(options.get('refreshDelay'));
        if ( refreshDelay < 2 ) {
            refreshDelay = 2;
        }
        return refreshDelay;
    }
    /**
     * Add default actions.
     */
    function addDefaultActions() {        
        // Add user defined Steams
        if (UserStreams.content.length > 0) {
            Util.each(UserStreams.content, function(index, data) {
                if (data.id && data.action) {
                    if (data.action.group!=='none' && Util.isSet(groupNames[data.action.group])) {
                        Actions.add(data.id, data.action);
                    }
                }
            });
        }
        Actions.add('DailyTakeV3_collect_stake', { 
            name       : 'Daily Take Reward',
            group      : 'doDailyTake',
            next       : collectDailyTake,
            skipif     : 'You have already collected'
        });
        Actions.add('war_view', {
            name       : 'Go to war',
            group      : 'doGotoWar',
            next       : helpInWar
        });
        Actions.add('war_share_reward_feed_click', {
            name       : 'Claim war reward',
            group      : 'doClaimBonusAndReward',
            next       : warRewardResult,
            fail       : 'You cannot claim this reward'
        });
        Actions.add('socialmission_joinMission', {
            name       : 'Join in a mission',
            group      : 'doSocialMissions',
            next       : joinOperation
        });
        Actions.add('robbing_mastery_bonus', {
            name       : 'Claim robbing mastery bonus',
            group      : 'doClaimBonusAndReward',
            next       : '.message_body a:regex(href,xw_action=mastery_bonus)'
        });
        Actions.add('index_ach_celeb', {
            name       : 'Get archivement reward',
            group      : 'doClaimBonusAndReward',
            next       : '.message_body a:regex(href,xw_action=ach_celeb)',
            fail       : 'You already got the bonus before|This bonus has expired'
        });
        Actions.add('story_claim_boss_bonus', {
            name       : 'Claim a boss bonus',
            group      : 'doClaimBonusAndReward',
            next       : '.message_body a:regex(href,xw_action=claim_boss_bonus)'
        });
        Actions.add('index_crm_levelup_claim', {
            name       : 'Get free Loyalty Points',
            group      : 'doClaimBonusAndReward',
            next       : '.message_body a:regex(href,xw_action=crm_levelup_claim)',
            skipif     : 'have already received the maximum amount',
            fail       : 'You are too late'             
        });
        Actions.add('propertyV2_getBoost', {
            name       : 'Get a property boost',
            group      : 'doPropertyHelp',
            next       : '.message_body a:regex(href,xw_action=getBoost)'
        });
        Actions.add('index_send_energy_mbox', {
            name       : 'Send energy',
            group      : 'doSendEnergyAndPhones',
            next       : '.message_body a:regex(href,xw_action=send_energy_mbox)'
        });
        Actions.add('socialmission_rewardBrag',        { 
            name       : 'Claim social mission reward',
            group      : 'doClaimBonusAndReward',
            fail       : 'You are too late to claim a reward.'
        });
        Actions.add('job_collect_loot', {
            name       : 'Collect a loot',
            group      : 'doPropertyHelp',
            skipif     : 'have to wait'
        });
        Actions.add('limitedTimeProperty_addPropertyPart', {
            name       : 'Send Limited Time Property Parts',     
            group      : 'doPropertyHelp',
            skipif     : 'You have already sent \\d+ parts today',
            fail       : 'You have already sent|feed have been claimed|feed has expired|has all parts needed|could not be completed'
        });
        Actions.add('limitedTimeProperty_addAnyPropertyPart', {
            name       : 'Send "Any" Limited Property Parts',     
            group      : 'doPropertyHelp',
            skipif     : 'You have already sent \\d+ parts today',
            fail       : 'You have already sent|feed have been claimed|feed has expired|You can only send parts to friend'
        });
        Actions.add('limitedTimeProperty_upgradeBragFeed',{ 
            name       : 'Limited Time Property Upgraded',
            group      : 'doPropertyHelp',
            skipif     : 'You already have all parts needed for this level',
            fail       : 'All rewards from this feed have been claimed|You have already collected|feed has expired'
        });
        Actions.add('fight_iced_boost_claim', {
            name       : 'Get iced boost',
            group      : 'doClaimBonusAndReward',
            skipif     : 'You can only receive \\d+ free iced fight boosts per day',
            fail       : 'This boost is no longer available'
        });
        Actions.add('fight_send_boost_from_feed',      { 
            name       : 'Collect Fight Boost',
            group      : 'doClaimBonusAndReward',
            fail       : 'This boost is no longer available|You have already received|You are too late' 
        });
        Actions.add('index_levelUpBonusClaim', {
            name       : 'Get levelup Bonus',
            group      : 'doClaimBonusAndReward',
            skipif     : 'You have already collected the maximum',
            fail       : 'available bonus rewards have already been claimed'
        });
        Actions.add('lootladderevent_share_feed_click', {
            name       : 'Collect a Share Loot Event',
            group      : 'doClaimBonusAndReward',
            skipif     : 'try again tomorrow'
        });
        Actions.add('lootladderevent_ask_feed_click', {
            name       : 'Collect an Ask Loot Event',
            group      : 'doClaimBonusAndReward',
            skipif     : 'try again tomorrow'
        });
        Actions.add('lootladderevent_brag_feed_click', {
            name       : 'Collect a Golden Loot Event',
            group      : 'doClaimBonusAndReward',
            skipif     : 'try again tomorrow'
        });
        Actions.add('Epicclanboss_ask_feed_click', { 
            name       : 'Collect Boss help item',
            group      : 'doClaimBonusAndReward',
            skipif     : 'You have already collected \\d+ Rifle Rounds today|You are at max capacity',
            fail       : 'You are too late|already collected'
        }); 
        Actions.add('job_give_help', { 
            name       : 'Give job help',
            group      : 'doGiveSocialHelp',
            skipif     : 'Try again tomorrow',
            fail       : 'You are too late to help|have already helped|already helped out'
        });
        Actions.add('story_give_help_social', { 
            name       : 'Give social help',
            group      : 'doGiveSocialHelp',
            skipif     : 'Try again tomorrow',
            fail       : 'You are too late to help|have already helped|already helped out'
        });
        Actions.add('story_give_help_moscow_social', { 
            name       : 'Give moscow help',
            group      : 'doGiveSocialHelp',
            skipif     : 'Try again tomorrow',
            fail       : 'You are too late to help|have already helped|already helped out|to be social network friends'
        });
        Actions.add('job_sd_boost_get', { 
            name       : 'Collect 2x loot boosts',
            group      : 'doClaimBonusAndReward',
            skipif     : 'you can only collect \\d+ boosts from feeds per day',
            fail       : 'these boosts have already been claimed|already helped your friend|this request has expired'
        });
        Actions.add('propertyV2_one_click_get', { 
            name       : 'Get Rob Squad',
            group      : 'doPropertyHelp',
            skipif     : 'can only collect \\d+ Rob Squads|you have too many Rob Squads in your inventory',
            fail       : 'already helped your friend|request has expired' 
        });
        Actions.add('propertyV2_collect_all_share', { 
            name       : 'Get Free Property Parts',
            group      : 'doPropertyHelp',
            skipif     : 'you have already collected the maximum amount',
            fail       : 'already helped your friend|you are too late'
        });
        Actions.add('propertyV2_itemFeedHelp', { 
            name       : 'Property item Help',
            group      : 'doPropertyHelp',
            skipif     : 'You have already helped \\d+ people today',
            fail       : 'has already received the maximum amount|You have already helped'
        });
        Actions.add('propertyV2_cs_redeem_special_item_feed',{ 
            name       : 'Property special help',
            group      : 'doPropertyHelp',
            fail       : 'cannot receive any more Exotic Feeds from you today'
        });
        Actions.add('ClanProperty_getPartsFromFeed', {
            match      : {
                'item_id=20000': {name: 'Get Reinforced Concrete'},
                'item_id=13000': {name: 'Get Artillery Shell'}
            },
            name       : 'Get Clan Property Parts',
            group      : 'doPropertyHelp',
            skipif     : 'already collected the maximum number',
            fail       : 'already collected from this request' 
        });
        Actions.add('index_levelup_boost_claim', { 
            name       : 'Get levelup boost',            
            group      : 'doClaimBonusAndReward',
            fail       : 'All of the available bonus rewards have already been claimed.',
        });
        Actions.add('FeedOfTheDay_feed_accept', { 
            name       : 'Collect Don\'s Gift',
            group      : 'doClaimBonusAndReward',
            fail       : 'already helped your friend with this request',
            skipif     : 'You have reached your limit for collecting'
        });
        Actions.add('job_mastery_feed_claim', { 
            name       : 'Collect job Mastery reward',
            group      : 'doClaimBonusAndReward',
            skipif     : 'have claimed the maximum number',
            fail       : 'You can only claim this reward once'
        });
        Actions.add('quest_questFeedReward', { 
            name       : 'Claim quest reward',
            group      : 'doClaimBonusAndReward',
            skipif     : 'you may only accept \\d+ rewards a day',
            fail       : 'the max number of people have already|you may only collect from a feed once|encountered an error'
        });
        Actions.add('job_accept_city_crew_feed', { 
            name       : 'Join in a crew',
            group      : 'doCityCrew',
            fail       : 'Crew queue is full|users already assisted|time limit to assist|You are already'
        });
        Actions.add('bossfightv2_ask_feed_click', { 
            name       : 'Collect a Boss Fight item',
            group      : 'doClaimBonusAndReward',
            fail       : 'feed has expired'
        });
        Actions.add('map_mapboss_reward_claim', { 
            name       : 'Claim boss reward', 
            group      : 'doClaimBonusAndReward',
            fail       : 'You have already received'
        });
        Actions.add('propertyV2_getCustomer', { 
            name       : 'Get a customer',
            group      : 'doPropertyHelp',
            fail       : 'You already helped this user' 
        });
        Actions.add('propertyV2_cs_help_item', { 
            name       : 'Send Property Parts',          
            group      : 'doPropertyHelp',
            fail       : 'has received all the help'
        });
        Actions.add('index_send_energy', { 
            name       : 'Send energy',
            group      : 'doSendEnergyAndPhones',
            fail       : 'You have already helped today|has already got their Energy'
        });
        Actions.add('index_power_pack_get', { 
            name       : 'Send Power Pack',
            group      : 'doSendEnergyAndPhones',
            fail       : 'already helped|feed is expired|you have too many'
        });
        Actions.add('robbing_call_for_help_get_phone', { 
            name       : 'Get robbing phone',
            group      : 'doSendEnergyAndPhones',
            fail       : 'too many friends help|You cannot help'
        });
        Actions.add('robbing_one_click_get',           { 
            name       : 'Get Rob Squad',
            group      : 'doSendEnergyAndPhones',
            fail       : 'you\'ve already helped'
        });
        Actions.add('job_accept_city_crew',            { name: 'Join in a crew',               group: 'doCityCrew' });
        Actions.add('propertyV2_cs_help_initial',      { name: 'Property Started',             group: 'doPropertyHelp' });
        Actions.add('propertyV2_cs_help_final',        { name: 'Property Upgraded',            group: 'doPropertyHelp' });

        
        /*
        Actions.add('freegifts_acceptGiftEvent',       { name: 'Collect Gift Event',           group: 'doClaimBonusAndReward' });
        Actions.add('hitlist_feed_hit', {
            name       : 'Hitlist Bounty',
            group      : 'doHitlistBounty',
            repeat     : '.message_body a:regex(href,action=attack), a:regex(href,action=power_attack)',
            bad        : '.message_body:has(span.bad)',
            success    : '.fight_results, .fightres_stats'
        });
        */
    }
    /**
     * Collect a link.
     * @param {String} url
     * @param {CSAction} action
     * @param {Function} callback 
     */
    function doHelp(url, action, callback)
    {
        httpAjaxRequest({
            url: url,
            success: function(htmlText)
            {
                if (!MW.update(htmlText)) {
                    callback(ERROR_BAD_RESPONSE);
                    return;
                }
                if (Util.isFunc(action.next)) {
                    action.next.apply(action, [htmlText, callback]);
                    return;
                }
                var $r, $html = h$(htmlText);
                
                if (action.next && ($r = $html.find(action.next)).length > 0) {
                    doHelp(getUrlFromElement($r), {}, callback, true);
                    return;
                }
                if (($r = $html.find('.message_body:first, #mbox_generic_1 tr:eq(1)')).length > 0) {
                    callback($r.html(), !Util.doRgxTest(action.fail, $r.text()));
                }
                else {
                    callback(ERROR_BAD_RESPONSE);
                }
            }
        });
    }
    /**
     * @param {Object} id
     */
    function removeFeed(id) {
        var $li = $('li[feed='+id+']');
        $li.fadeOut(500, qryAction($li, 'remove'));
        feedStream.remove(parseInt(id));
        $('#total_feeds', '#feed_center_header').html(feedStream.length());
    }
    /**
     * Add an error message.
     */
    function showErrorMessage() {
        showDiv('feedlist', 'body');
        $('#status_panel').empty().append(
            c$('div').css({'text-align':'center', 'padding-top':5})
            .append(c$('span').text('There is some error in facebook response.'))
            .append(b$('Retry','class:short white').css('margin-left',5).click(Events.refresh_click))
            .append(b$('Cancel','class:short white').css('margin-left',5).click(Events.skip_click))
        );
    }
    /**
     * Check a filter, return false if filter match the text or it's disabled.
     * @param {String} sText text to check.
     * @param {String} sUse use option name to enable/disable this filter
     * @param {String} sFilter filter option name to get the filter.
     * @return {Boolean}
     */
    function checkFilter(sText, sUse, sFilter) {
        sFilter = String( options.get(sFilter) );
        if ( options.get(sUse) && sFilter.length > 1 ) {
            return !( new RegExp(sFilter.replace(/\s*,\s*/g,'|'),'i') ).test(sText);
        }
        return false;
    }
    /**
     * Help in a war.
     * @param {String} htmlText
     * @return {Boolean, String}
     */
    function helpInWar(htmlText, callback) {
        var $html = h$(htmlText);
        var reward = $html.find('.helpers_rewards ul img').attr('title');
        var message = 'Wrong War Loot. ( '+reward+' )';
        var isLimited = false;
        var queries = {
            att: 'a:regex(href,xw_controller=war&xw_action=attack)',
            shr: '.war_attacks div.left a:regex(href,controller=stats)',
            scs: '.post_help_results p, .pop_box > div > div > div:eq(1)',
            msg: '.message_body:first'
        };
        if (!reward) {
            callback( 'Unknow War loot.', false );
            return;
        }
        if (Util.length(options.warloot) < 1 && options.warlootLimited.enabled !== true) {
            callback( 'Your War Loot filter is empty.', false );
            return;
        }
        if ($html.find(queries.att).length < 1) {
            callback( 'This war is already over.', false );
            return;
        }
        /**
         * @param {String} url
         */
        function attackTo(url, loot_id) {
            httpAjaxRequest({
                'url': url, 
                'success': function(htmlText) {
                    if (!MW.update(htmlText)) {
                        callback(ERROR_BAD_RESPONSE);
                        return;
                    }
                    var $pop = Util.parsePopup(htmlText);
                    var $html = h$(htmlText);
                    var $att = $html.find(queries.att);
                    if ($att.length > 0) {
                        attackTo( getUrlFromElement($att) );
                    } else {
                        if ($pop && $pop.length>0 && $pop.find) {
                            message = $pop.find(queries.scs).text();
                        } else {
                            message = $html.find(queries.msg).text();
                        }
                        postWarResult($html, loot_id);
                    }
                }
            });
        }
        /**
         * @param {jQuery} $html
         */
        function postWarResult($html, loot_id) {
            var failed = true;
            $html.find(queries.shr).each(function(i, a){
                try {
                	var id = Base64.decode(Util.uSplit(a.href).user);
                	if (global.USER_ID === id) {
                        if (isLimited) {
                            if (Util.isNumber(options.warLimitCount)) {
                                options.warLimitCount++;
                            } else {
                                options.warLimitCount = 1;
                            }
                            options.save();
                        } else if (options.warlootSecundaryLimit === true && loot_id) {
                            options.warloot[loot_id].enabled = false;
                        }
                        Logger.debug('Helped in War with loot: ( '+reward+' )');
                        callback( message, true );
                	    return (failed=false);
                	}
                } catch(e){}
            });
            if (failed) {
                callback( message, false );
            }
        }
        if (options.warlootLimited.enabled) {
            if (testWarFilter(options.warlootLimited)) {
                isLimited = true;
                attackTo(getUrlFromElement($html.find(queries.att)));
                return;
            }
            if (options.warLimitCount < 5) {
                callback( 'You need to collect +'+(5-options.warLimitCount)+' of your primary loot: ( '+reward+' )', false );
                return;
            }
        }
        for (var id in options.warloot) {
            if (testWarFilter(options.warloot[id])) {
                attackTo(getUrlFromElement($html.find(queries.att)), id);
                return;
            }
        }
        function testWarFilter(data) {
            if (!data.enabled) {
                return false;
            }
            var expr_name = new RegExp(data.name==='*'?'.':data.name, 'i');
            var attack = parseInt(Util.doRgx(/Attack:\s?(\d+)/i,reward).$1||1);
            var defense = parseInt(Util.doRgx(/Defense:\s?(\d+)/i,reward).$1||1);
            return expr_name.test(reward) && (attack>=parseInt(data.att)||defense>=parseInt(data.def));
        }
        
        callback( message, false );
    }
    /**
     * Parse a war reward help.
     * @param {Object} htmlText
     */
    function warRewardResult(htmlText, callback) {
        var $h = h$(htmlText);
        var popup = Util.parsePopup(htmlText);
        var message = String($('.pop_box > div > div > div:eq(1)',popup).text()||$h.find('.message_body:first').text());
        var success = (!Util.doRgxTest(this.fail, message) && message.length > 0)
        if (message.length < 1) {
            message = 'There was some error.';
        }
        callback(message, success);
    }
    /**
     * Collect a Daily Take.
     * @param {String} htmlText
     * @param {Function} callback
     */
    function collectDailyTake(htmlText, callback) {
        var temp = Util.parsePopup(htmlText);
        var rewards = new CSDailyTakeLootCollection();
        /**
         * Return an expression to match loot names.
         * @return {String}
         */
        function createPriorityName() {
            var text = Util.trim(String(options.dtLootPriority));
            if (!Util.isString(text) || text.length < 1) {
                return;
            } 
            else if (/\n/.test(text)) {
                text = text.split(/\n/).join('|');
            }
            return text;
        }
        /**
         * Parse collect popup and return the text. 
         * @param {CSDailyTakeLoot} loot
         */
        function collectAndReturn(loot) {
            httpAjaxRequest({
                'url': loot.url, 
                'success': function(htmlText) {
                    var response = h$(htmlText).find('#collectText');
                    if (response.length > 0) {
                        callback( response.text(), true );
                    } else {
                        callback( 'Seem that an user has received the reward before you.');
                    }
                }
            });
        }
        $('#dt_body_area .collectbox .dt_pop_item',temp).each(function(i, elem) {
            rewards.add(new CSDailyTakeLoot(elem));
        });
        if (rewards.length() < 1) {
            if ((temp = h$(htmlText).find('.message_body')).length > 0) {
               callback(temp.text());
            } else {
               callback('This "Daily Take" was taken.'); 
            }
            return;
        }
        if ( (temp = createPriorityName()) ) {
            if ( (temp = rewards.getByName(temp)) ) {
                collectAndReturn( temp );
                return;  
            }
        }
        if (options.dtCheckMinAtkDef) {
            if ( (temp = rewards.getByStats(options.dtMinAttack, options.dtMinDefense)) ) {
                collectAndReturn( temp );
                return;  
            }
        }
        callback( 'Filtered. ('+ rewards.names() +')' );
    }    
    /**
     * Try join in an operation
     * @param {String} htmlText
     * @param {Function} callback
     */
    function joinOperation(htmlText, callback)
    {
        var qHtml = h$(htmlText);

        if (e$('.socialMissionSelector', qHtml) == null) {
            callback('You can\'t join. Try helping out other mafia members.');
            return;
        }
        try {
            var nFree   = options.get('maxFreeSlots');
            var sName   = $('.missionSelectHeaderTitle', qHtml).text();
            var sDiff   = $('.missionDifficulty > span', qHtml).attr('class');
            var nSpend1 = parseInt($('#hfopt_joinmission').val());
            var nSpend2 = parseInt($('#hfopt_joinmissionafter').val());
            var sQuery  = 'a:regex(onclick,action=selectPosition)';
            var nSlots  = $(sQuery, qHtml).length;
            var cSlots  = new Array();
            
            if ( checkFilter(sName, 'opUseNameFilter', 'opNameFilter') ) {
                callback('Filtered name "'+sName+'".');
                return;
            }
            if (nSlots > nFree) {
                callback('Filtered "'+ sName + '". Too many slots free ('+nSlots+').');
                return;
            }
            if (!options.get('diff_' + sDiff.toLowerCase())) {
                callback('Filtered "'+ sName + '". Difficulty don\'t match.');
                return;
            }
            $('.missionSelectorBox:has('+sQuery+')', qHtml).each(function(index,elem) {
                var nSpendType = 0;
                var hasEnergy  = (e$('dd.energy', elem) !== null);
                var hasStamina = (e$('dd.stamina', elem) !== null);

                if ((hasEnergy || hasStamina) && !Util.isSet(cSlots[4])) {
                    cSlots[4] = $(sQuery, elem);
                }
                if (hasEnergy && !hasStamina) {
                    nSpendType = 1;
                }
                else if (!hasEnergy && hasStamina) {
                    nSpendType = 2;
                }
                else if (hasEnergy && hasStamina) {
                    nSpendType = 3;
                }

                if (!Util.isSet(cSlots[nSpendType])) {
                    Logger.debug('Adding SpendType: '+ nSpendType);
                    cSlots[nSpendType] = $(sQuery, elem);
                }
            });

            var button = (cSlots[nSpend1] || cSlots[nSpend2]);

            if (typeof(button) == 'undefined' || button.length < 1) {
                callback('Filtered "'+ sName + '". Spend type don\'t match.');
                return;
            }
        }
        catch(err) {
            Logger.error(err);
            callback(ERROR_BAD_RESPONSE);
            return;
        }

        httpAjaxRequest({
            url: getUrlFromElement(button),
            success: function(htmlText)
            {
                if (MW.update(htmlText))
                    callback('You has join in "' + sName + '" mission.', true);
                else
                    callback(ERROR_BAD_RESPONSE);
            }
        });
    }

    function showDiv(name, type, ms, fn) {
        $('div[id*=_'+type+']', popupElt.content).hide();
        var elem = $('#' + name + '_' + type, popupElt.content);
        if (ms) {
            elem.fadeIn(ms, fn);
        }
        else {
            elem.show();
        }
    }
    /**
     * Add a new success action.
     * @param {CSStream} stream
     * @param {String} responseText
     */
    function addHelpLog(stream, responseText) {
        var $log = $('#logList');
        var title = stream.action.name;
        var feed = stream.feed;

        if ($log.children().length > options.get('maxLogLength')) {
            $log.children().last().remove();
        }
        var $li = c$('li'), $wrapper, $buttons;
        var atch = feed.attachment;
        var $title = c$('a','target:_black').attr('href',feed.permalink).text(atch.name||atch.description);
        var $img = atch.media[0]
        ? c$('img','class:feed_icon,title:'+title).attr('src',atch.media[0].src)
        : c$('span');
        
        $wrapper = c$('div').addClass('li_wrapper clearfix').appendTo($li).append($img);
        $buttons = c$('div','class:buttons').appendTo($wrapper)
        .append(c$('a','href:#,class:ignore,postid:'+feed.post_id).text('like it').click(Events.likeFeed_click))
        .append(c$('div').css('clear','both'));
        c$('div','class:body').append(c$('h4').append($title)).append(c$('p').html(responseText)).appendTo($wrapper);
        
        $li.prependTo($log);
        $wrapper.mouseenter(Events.selectHelp).mouseleave(Events.unselectHelp);
        addCommentFeed($buttons, feed.post_id, responseText);
    }
    /**
     * Add a new skip/fail action.
     * @param {CSStream} stream
     * @param {String} message
     */
    function addSkippedLog(stream, message) {
        var timestamp = Util.setColor('['+(new Date()).toLocaleTimeString()+ '] ', 'grey');
        var $log = $('#logSkippedList');
        var streamName = Util.setAnchor(stream.feed.permalink, stream.action.name);
         
        if ($log.children().length > options.get('maxLogLength')) {
            $log.children().last().remove();
        }
        Resources.getPicture('info_icon','li').prependTo($log)
        .append(c$('p').html(timestamp+' '+streamName+': '+message));
    }
    /**
     * Send a message when auto collecting
     * @param {String} text
     */
    function sendMessage(text) {
        Resources.getPicture('ajax_loader', 'span').css('padding-left', 18)
        .appendTo($('#auto_feed_helper_messages').empty()).html(text);
    }

    function StartCollector() {
        var nDelay         = options.get('helpDelay');
        var nRefreshDelay  = getRefreshDelay();
        var nCompleted     = 0;
        var nSkipped       = 0;

        function toNextStream(message, delay) {
            if (cancel_process) {
                return;
            }
            $('#completed_helps').text(nCompleted);
            $('#skipped_helps').text(nSkipped);
            $('#total_feeds', '#feed_center_header').html(feedStream.length());
            // no more streams
            if (feedStream.length() < 1) {
                messageTimer.start('All helps finished!. continue in %N% seconds.',nRefreshDelay, updateStreams);
                return;
            }
            // if no delay, skip timer
            if (!delay) {
                collectStream(feedStream.shift());
            } else {
                messageTimer.start(''+message, delay, function() {
                    collectStream(feedStream.shift());
                });
            }
        }
        /**
         * @param {CSStream} cStream
         */
        function collectStream(cStream) {
            if (cancel_process) {
                return;
            }
            /**
             * Skip current stream
             * @param {String} sReason
             */
            function skipHelp(sReason) {
                Logger.debug(cStream.action.name+' skipped.');
                if (Util.isSet(sReason)) {
                    addSkippedLog(cStream, sReason);  
                }
                nSkipped++;
                toNextStream();
            }
            
            // skip if stream or action is undefined
            if ( !Util.isSet(cStream) || !Util.isSet(cStream.action) ) {
                toNextStream();
                return;
            }
            try {
                if ( cStream.isCollected() ) {
                    skipHelp();
                    return;
                }
	            // skip if stream group isn't enabled.
	            if (!options.get(cStream.gid)) {
                    skipHelp();
                    return;
                }
	            // skip if stream isn't enabled.
	            if (Util.isSet(options.get(cStream.gid.substr(2)))) {
	                if (options.get(cStream.gid.substr(2))[cStream.id] === false) {
                        skipHelp();
	                    return;
	                }
	            }
	            // skip if this stream can't be collected today
	            if (cStream.action.skip === true) {
                    skipHelp();
	                return;
	            }
                // collect the stream
                sendMessage('Helping in:  '+cStream.action.name);
                console.log(cStream.action);
                doHelp(cStream.url, cStream.action, function(response, success) {
                    response = cleanResponse(response);
                    cStream.collected();
                    cStream.action.skip = Util.doRgxTest(cStream.action.skipif, response);
                    if (cStream.action.skip || success !== true) {
                        addSkippedLog(cStream, response); 
                    } else {
                        addHelpLog(cStream, response);
                    }
                    nCompleted++;
                    toNextStream('Done!, Next in %N%...',nDelay);
                });
            }
            catch (err) {
                Logger.error('collectStream: ' + err.message);
                toNextStream();
            }
        }

        function updateStreams() {
            if (cancel_process) {
                return;
            }
            function retry(msg) {
                messageTimer.start(msg,nRefreshDelay,updateStreams);
            }
            sendMessage('Refreshing home posts...');

            queryFeeds(function(fs) {
                if (fs && fs.error) {
                    retry(fs.error.message+' try again in %N%...');
                    return;
                }
                if (!Util.isArray(fs) || fs.length < 1) {
                    retry('Error loading posts, try again in %N%...');
                    return;
                }
                // if empty, update again
                if ((feedStream = new CSStreamCollection(fs, true)).length() < 1) {
                    retry('No new posts, try again in %N%...');
                    return;
                }
                // update stream amout
                $('#total_feeds', '#feed_center_header').html(feedStream.length());

                // start collecting first stream
                collectStream(feedStream.shift());   
            });
        }

        //=========
        // Generate code for auto help messages
        $('#status_panel').empty();

        c$('div').appendTo('#status_panel').css({
            'padding':'5px 0 0 15px',
            'float': 'left'
        })
        .append(c$('span').css('color','green').text('Success: '))
        .append(c$('span','completed_helps').text(0))
        .append(c$('span').css({'color':'green','margin-left':5}).text('Skip: '))
        .append(c$('span','skipped_helps').text(0))

        c$('div','auto_feed_helper_messages').appendTo('#status_panel').html('Preparing...').css({
            'padding':'5px 0 0 30px',
            'float': 'left'
        });
        b$('CANCEL', 'class:short red').click(Events.cancel_click).appendTo('#status_panel').css({
            'float': 'right',
            'margin-right': 40
        });

        // toggle layers
        showDiv('automode', 'body');
        showDiv('status', 'panel', 500);

        // update options
        options.fromDomElements();
        options.save(function() {
            // rest the cancel variable
            cancel_process = false;
            // start
            if ( feedStream.length() > 0 ) {
                feedStream.slice( options.feedsLimit );
                collectStream(feedStream.shift());
            } else {
                updateStreams();
            }
        });
    }
    function genMainDom() {
        var $control = c$('div', 'control_panel').height(35)
        var $config = c$('div', 'config_panel');
        var $group = c$('select', 'id:hfopt_grouping').width(152);
        var $cfgselect = c$('div', 'id:main_selector,class:select_tab').css({
            width: 250,
            height: 200
        });
        // fix content height
        popupElt.content.css('margin-top', 5);

        // header popup
        c$('dl', 'class:total_requests')
        .appendTo(c$('div', 'feed_center_header').appendTo(popupElt.header))
        .append('<dt id="total_feeds">'+feedStream.length()+'</dt>')
        .append('<dd>Total Posts</dd>');
        
        c$('div','id:minipopup_overlay').appendTo(popupElt.content);
        c$('div','id:minipopup_content').appendTo(popupElt.content);
        
        // middle, config, buttons
        c$('div', 'panel_container').appendTo(popupElt.content)
        .append(c$('div', 'status_panel').height(35)).append($control).append($config);

        c$('div', 'class:search_box').appendTo($control)
        .append(c$('label', 'for:hfopt_filter').text('Search: '))
        .append(c$('input:text', 'id:hfopt_filter').width(149).keyup(Events.keyup))
        .append($group.change(Events.change));

        c$('div', 'class:control_box').appendTo($control)
        .append(b$('Clear all', 'class:short white').click(Events.clearall))
        .append(b$('Refresh','class:short orange').css('margin-left',5).click(Events.refresh_click))
        .append(b$('Config','class:short orange').css('margin-left',5).click(Events.config_click))
        .append(b$('AutoHelp','class:short orange').css('margin-left',10).click(StartCollector));
        
        // add options checkboxes and group list
        $cfgselect.appendTo($config);
        
        Util.each(groupNames, function(id, name) {
            var $elm = c$('div', 'name:'+id).appendTo($cfgselect).click(Events.config_change);
            // add the group to the filter            
            $group.append(c$('option', 'value:'+id).text(name));
            // add the group to configuration
            if (id !== 'none') {
                $elm.append(x$('hfopt_'+id.toLowerCase()).css('margin',0));
            }
            c$('p').text(name).appendTo($elm);
        });
        $('div[name=none]', $cfgselect).addClass('selected');
        
        $config        
        .append( c$('div', 'class:config_tab,id:none_config')                  .append(genGeneralConfig())                             )
        .append( c$('div', 'class:config_tab,id:doGotoWar_config')             .append(genWarFilter())                                 )
        .append( c$('div', 'class:config_tab,id:doGiveSocialHelp_config')      .append(genMultiCheckboxConfig('GiveSocialHelp'))       )
        .append( c$('div', 'class:config_tab,id:doSocialMissions_config')      .append(genMissionConfig())                             )
        .append( c$('div', 'class:config_tab,id:doClaimBonusAndReward_config') .append(genMultiCheckboxConfig('ClaimBonusAndReward'))  )
        .append( c$('div', 'class:config_tab,id:doPropertyHelp_config')        .append(genMultiCheckboxConfig('PropertyHelp'))         )
        .append( c$('div', 'class:config_tab,id:doAcceptGiftEvent_config')     .append(genEmptyConfig())                               )
        .append( c$('div', 'class:config_tab,id:doCityCrew_config')            .append(genEmptyConfig())                               )
        .append( c$('div', 'class:config_tab,id:doDailyTake_config')           .append(genDailyTakeFilter())                           )
        .append( c$('div', 'class:config_tab,id:doSendEnergyAndPhones_config') .append(genEmptyConfig())                               )
        .append( c$('div', 'class:save_config').append(b$('Save Configuration','class:short orange').click(Events.save_click))         );

        // ADD BODY ELEMENTS
        c$('div').appendTo(popupElt.content).css({'width':'100%','height':35});
        c$('div', 'feedlist_body').height(700).appendTo(popupElt.content);
        c$('div', 'ajaxloader_body').css('padding-top',25).height(675)
        .append(c$('img').attr('src', global.zGraphicsURL+'socialmissions/ajax-loader.gif'))
        .appendTo(popupElt.content);
        c$('div', 'automode_body').height(700)
        .append(c$('ul', 'id:logList,class:feed_box').height(400)).css('border-bottom','2px solid #333;')
        .append(c$('ul', 'id:logSkippedList,class:skipped_log').height(300))
        .appendTo(popupElt.content);
        
        // =====================

        function genEmptyConfig() {
            return c$('center').css('margin-top', 10)
            .html('This category don\'t have any configuration.');
        }
        function genMultiCheckboxConfig(id) {
            var $elm = c$('div');
            var grp = String(id).toLowerCase();
            var opts = options.get(id);
            var $tlb = c$('div', 'class:select_tab,name:checkboxlist,id:hfopt_'+grp);
            
            $tlb.height(150).width(400).appendTo($elm);
            t$('action_skipif', 'Skip Check:', 335, {
                'change'   : Events.action_issue_change,
                'focusout' : Events.action_issue_change
            }).appendTo($elm).css({'float':'right','margin':'5px 0px 0px 0px'});
            t$('action_fail', 'Fail Check:', 335, {
                'change'   : Events.action_issue_change,
                'focusout' : Events.action_issue_change
            }).appendTo($elm).css({'float':'right','margin':'5px 0px 0px 0px'});
            
            Actions.each(function(name, action) {
                var skipif = options.actions.skipif[name];
                var fail = options.actions.fail[name];
                if ( action.group !== 'do'+id ) { return; }
                if ( !Util.isSet(opts[name]) )  { opts[name] = true; }
                if ( Util.isString(skipif)&& skipif.length>0 ) { action.skipif = skipif; }
                if ( Util.isString(fail)  && fail.length > 0 ) { action.fail = fail; }
                c$('div', 'name:'+name).appendTo($tlb).click(Events.subconfig_change)
                .append(x$(name).attr('value',name).css('margin',0))
                .append(c$('p').text(action.name));
            });
            return $elm;
        }
        function genGeneralConfig() {
            var $div = c$('div');
            var tabs = new TabObject({
                id: 'hfc_filters_wrapper',
                appendTo: $div,  height: 177,
                tabs: ['General', 'Friends', 'Friend List']
            });
            c$('div').css('padding',5).appendTo(tabs.content[0])
            .append(n$('hfopt_feedslimit', 'Feeds Limit', 100))
            .append(c$('div').css({'clear':'both','margin-top':5}))
            .append(s$('hfopt_maxloglength', 'Log Length:', 100))
            .append(c$('div').css({'clear':'both','margin-top':5}))
            .append(s$('hfopt_helpdelay', 'Help delay:', 100))
            .append(c$('div').css({'clear':'both','margin-top':5}))
            .append(s$('hfopt_refreshdelay', 'Refresh delay:',100));
            
            c$('div', 'class:ui-filterlist').appendTo(tabs.content[1])
            .append(c$('div', 'class:ui-top') 
            .append(x$('hfopt_fblistfilteron', 'Friendlist filter:'))
            .append(c$('div', 'class:ui-right').css('margin-right',4)
            .append(c$('a', 'href:#,class:ui-button').text('Edit').click(Events.addFblistToFilter_click))
            .append(c$('a', 'href:#,class:ui-button').text('Clear').click(Events.clearFblistFilter_click))))
            .append(c$('select', 'id:hfopt_fblistfilter,multiple:multiple'));
            
            c$('div', 'class:ui-filterlist').appendTo(tabs.content[2])
            .append(c$('div', 'class:ui-top')
            .append(x$('hfopt_userfilteron', 'Friends filter '))
            .append(c$('div', 'class:ui-right').css('margin-right',4)
            .append(c$('a', 'href:#,class:ui-button').text('Edit').click(Events.addUserToFilter_click))
            .append(c$('a', 'href:#,class:ui-button').text('Clear').click(Events.clearUserFilter_click))))
            .append(c$('select', 'id:hfopt_userfilter,multiple:multiple'));
            
            return $div;
        }
        function genWarFilter() {
            var $div = c$('div')
            .append(c$('div').html('Primary Loot <span id="warlimit_count" style="color:green">(0/5)</span>:')
            .append(c$('div', 'class:ui-right')
            .append(c$('a', 'href:#,class:ui-button,limited:1').text('Edit').click(Events.addWarloot))
            .append(c$('a', 'href:#,class:ui-button').text('reset').click(Events.resetLimitedWarloot))))
            .append(c$('div').css('clear','both'))
            .append(c$('input:text', 'id:warlootlimited_data').width(420))
            .append(c$('div').text('Secundary Loot:').css({'clear':'both','margin-top':5})
            .append(x$('hfopt_warlootsecundarylimit', 'One time.').css('margin-left',15))            
            .append(c$('div', 'class:ui-right')
            .append(c$('a', 'href:#,class:ui-button').text('Add').click(Events.addWarloot))
            .append(c$('a', 'href:#,class:ui-button').text('Edit').click(Events.editWarloot))
            .append(c$('a', 'href:#,class:ui-button').text('Remove').click(Events.removeWarloot))
            .append(c$('a', 'href:#,class:ui-button').text('toggle').click(Events.toggleWarloot))))
            .append(c$('select','id:warloot_data,multiple:multiple').css({'width':420,'height':140,'margin-top':2}));
            
            return $div;
        }
        function genDailyTakeFilter() {
            return c$('div')
            .append(c$('div').text('1st CHECK -> Loot Priority/Filter'))
            .append(c$('textarea', 'cols:50,rows:8,id:hfopt_dtlootpriority'))
            .append(c$('div').css('clear','both').css('margin-top',5))
            .append(x$('hfopt_dtcheckminatkdef', '2nd Check -> Minimal Attack/Defense', 'div'))
            .append(n$('hfopt_dtminattack', 'Minimal Attack:', 60))
            .append(n$('hfopt_dtmindefense', '-OR- Minimal Defense:', 60));
        }
        function genMissionConfig() {
            var $elm = c$('div');
            c$('div').css('margin',5)
            .append(c$('span').text('Mission difficulty: '))
            .append(c$('input:checkbox', 'id:hfopt_diff_easy'))
            .append(c$('label', 'for:hfopt_diff_easy').text('Easy'))
            .append(c$('input:checkbox', 'id:hfopt_diff_medium'))
            .append(c$('label', 'for:hfopt_diff_medium').text('Medium'))
            .append(c$('input:checkbox', 'id:hfopt_diff_hard'))
            .append(c$('label', 'for:hfopt_diff_hard').text('Hard'))
            .append(c$('input:checkbox', 'id:hfopt_diff_event'))
            .append(c$('label', 'for:hfopt_diff_event').text('Event'))
            .appendTo($elm);

            c$('div').css('margin',5)
            .append(c$('label', 'for:hfopt_joinmission').text('Join only in: '))
            .append(c$('select', 'id:hfopt_joinmission').width(90))
            .append(c$('label', 'for:hfopt_joinmissionafter').text(' if not possible then: '))
            .append(c$('select', 'id:hfopt_joinmissionafter').width(90))
            .appendTo($elm);

            c$('div').css('margin',5)
            .append(c$('label', 'for:hfopt_maxfreeslots').text('And only if remain: '))
            .append(c$('select', 'id:hfopt_maxfreeslots').width(110))
            .appendTo($elm);

            c$('div').css('margin',5)
            .append(x$('hfopt_opusenamefilter', 'Active Operation Name Filter:'))
            .append(c$('br'))
            .append(c$('textarea', 'cols:45,rows:6,id:hfopt_opnamefilter'))
            .appendTo($elm);

            return $elm;
        }

        popupElt.applyOptions({
            'hfopt_userfilteraction'  : {'skip':'Skipping', 'help':'Helping'},
            'hfopt_maxloglength'      : {50:'50', 200:'200', 500:'500', 1000:'1000'},
            'hfopt_joinmission'       : {4:'Any', 1:'Energy', 2:'Stamina', 3:'Both'},
            'hfopt_joinmissionafter'  : {0:'None', 1:'Energy', 2:'Stamina', 3:'Both', 4:'Any'},
            'hfopt_maxfreeslots'      : {100:'Any slots', 1:'1 slot', 2:'2 slots', 3:'3 slots', 4:'4 slots'},
            'hfopt_helpdelay'         : {0:'None', 1:'1 sec', 2:'2 sec', 3:'3 sec', 5:'5 sec'},
            'hfopt_refreshdelay'      : {2:'2 sec', 5:'5 sec', 15:'15 sec', 30:'30 sec', 60:'1 min', 180:'3 min', 300:'5 min', 600:'10 min'}
        });
    }

    function genFeedsDom() {
        var $li, $ul = c$('ul', 'class:feed_box').height(700);
        // ADD FEEDS
        feedStream.each(function(index, obj) {
            var feed  = obj.feed;
            var atch  = feed.attachment;
            var name  = '<a href="'+feed.permalink+'" target="_black">';
            var desp  = atch.description ? atch.description : atch.caption;
            
            name += (atch.name||atch.caption||atch.description) + '</a>';
            
            $li = c$('li', 'gid:'+(obj.gid||'none')+',feed:'+index).appendTo($ul);
            if (obj.isNew) {
                $li.addClass('new_post');
            }
            $li = c$('div', 'class:li_wrapper clearfix').appendTo($li);
            if (atch.media && atch.media[0] && atch.media[0].src) {
                c$('img', 'class:feed_icon').attr('src', atch.media[0].src).appendTo($li);
            }
            c$('div','class:buttons state_accept').appendTo($li)
            .append(b$('Help', 'class:medium white,feed:'+index).click(Events.helpFeed_click))
            .append(c$('a', 'href:#,class:ignore,feed:'+index).text('ignore').click(Events.deleteFeed_click));
            c$('div','class:buttons state_completed').appendTo($li).css('display','none')
            .append(b$('Clear', 'class:medium white,feed:'+index).click(Events.deleteFeed_click))
            .append(c$('div').css('clear','both'))
            .append(c$('a','href:#,class:ignore,postid:'+feed.post_id).text('like it').click(Events.likeFeed_click))
            .append(c$('div').css('clear','both'));
            
            c$('div','class:body').append('<h4>'+name+'</h4><p>'+desp+'</p>').appendTo($li);
        });
        $('#feedlist_body').empty().append($ul);
        $('#total_feeds', '#feed_center_header').html(feedStream.length());
        if ($('#hfopt_grouping').val() !== 'none') {
            $('#hfopt_grouping').change();
        }
    }
    
    function loadError() {
        var new_limit = Math.max(parseInt(options.feedsLimit/2), 25);
        if (options.feedsLimit > 25) {
            showHelpPopup({
                icon: 'error',
                title: 'No home posts found',
                message: 'There was an error while loading your home posts<br>'
                +        'would you like to reset feeds limit and disable friends filter before try again?.',
                buttons: [{
                    label: 'Yes',
                    addClass: 'short white',
                    onclick: function() {
                        options.fbListFilterOn = false;
                        options.userFilterOn = false;
                        options.feedsLimit = 50;
                        options.save(Initialize);
                    }
                }, {
                    label: 'No'
                }]
            });
        } else {
            showHelpPopup({
                icon: 'error',
                title: 'No home posts found',
                message: 'There was an error while loading your home posts<br>'
                +        'And your feed limit is very low, try again later.'
            });
            popupElt.destroy();
        }
    }
    function queryFeeds(callback) {
        var args = {'limit':options.feedsLimit};
        if (options.fbListFilterOn===true && Util.length(options.fbListFilter) > 0) {
            args.flid = new Array();
            Util.each(options.fbListFilter, function(id) { 
                args.flid.push('"'+id+'"'); 
            });
        }
        if (options.userFilterOn===true && Util.length(options.userFilter) > 0) {
            args.uid = new Array();
            Util.each(options.userFilter, function(id) { 
                args.uid.push('"'+id+'"'); 
            });
        }
        facebook.queryFeed(callback, args);
    }
    
    function Initialize() {
        var overlay = loadingScreen('Loading home posts...');

        queryFeeds(function(fs) {
            overlay.hide();
            if (!Util.isSet(fs) || fs.error || fs.length < 1) {
                loadError();
                return;
            }
            Actions = new CSActionCollection();
	        // add all pre-configured actions
	        addDefaultActions();
            feedStream = new CSStreamCollection(fs);
            Logger.debug('HFC: '+ feedStream.length());

            genMainDom();
            options.toDomElements();
            genFeedsDom();
            updateWarLoot();

            showDiv('feedlist', 'body');
            showDiv('control', 'panel');
            showDiv('none', 'config');

            // show popup
            popupElt.applyCustomClass();
            popupElt.show();
        });
    }

    popupElt.addBase64Style(
        'I2ZlZWRfY2VudGVyX2hlYWRlciB7DQoJZmxvYXQ6IHJpZ2h0Ow0KCWhlaWdodDogNjRweDsNCgltYXJnaW4tcmlnaHQ6IDUwcHg7'+
        'DQoJbWFyZ2luLXRvcDogNnB4Ow0KfQ0KI2ZlZWRfY2VudGVyX2hlYWRlciBkbC50b3RhbF9yZXF1ZXN0cyB7DQoJZmxvYXQ6IGxl'+
        'ZnQ7DQoJZm9udC13ZWlnaHQ6IGJvbGQ7DQoJbWFyZ2luOiAxNHB4IDBweCAwcHg7DQp9DQojZmVlZF9jZW50ZXJfaGVhZGVyIGRs'+
        'LnRvdGFsX3JlcXVlc3RzIGR0IHsNCgliYWNrZ3JvdW5kOiB1cmwoJHtiYXNlX3VybH16bWMvdG90YWxfcmVxdWVzdHNfYnViYmxl'+
        'XzM4eDM4XzAxLnBuZykgbm8tcmVwZWF0IDBweCAwcHg7DQoJZmxvYXQ6IGxlZnQ7DQoJZm9udC1zaXplOiAxOHB4Ow0KCWhlaWdo'+
        'dDogMzhweDsNCglsaW5lLWhlaWdodDogMzhweDsNCgltYXJnaW4tcmlnaHQ6IDZweDsNCgl0ZXh0LWFsaWduOiBjZW50ZXI7DQoJ'+
        'd2lkdGg6IDM4cHg7DQp9DQojZmVlZF9jZW50ZXJfaGVhZGVyIGRsLnRvdGFsX3JlcXVlc3RzIGRkIHsNCgliYWNrZ3JvdW5kOiB1'+
        'cmwoJHtiYXNlX3VybH16bWMvdG90YWxfcmVxdWVzdHNfYmdfMjAweDI0XzAxLnBuZykgbm8tcmVwZWF0IDEwMCUgNTAlOw0KCWZv'+
        'bnQtc2l6ZTogMTJweDsNCgloZWlnaHQ6IDM4cHg7DQoJbGluZS1oZWlnaHQ6IDM4cHg7DQoJbWFyZ2luLWxlZnQ6IDVweDsNCglw'+
        'YWRkaW5nOiAwcHggMjBweCAwcHggMzlweDsNCgl3aGl0ZS1zcGFjZTogbm93cmFwOw0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVw'+
        'IC5ibGFja19ib3ggew0KCWZvbnQtd2VpZ2h0OiBib2xkOyANCgljb2xvcjogcmdiKDIwOCwgMjA4LCAyMDgpOyANCglib3JkZXI6'+
        'IDFweCBzb2xpZCByZ2IoMTUzLCAxNTMsIDE1Myk7IA0KCWJhY2tncm91bmQtY29sb3I6IGJsYWNrOyANCglmb250LXNpemU6IDE0'+
        'cHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgdWwuZmVlZF9ib3ggew0KICAgIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTsNCiAg'+
        'ICBvdmVyZmxvdzogYXV0bzsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCB1bC5za2lwcGVkX2xvZyB7DQogICAgbGlzdC1zdHls'+
        'ZS10eXBlOiBub25lOw0KICAgIG92ZXJmbG93OiBhdXRvOw0KICAgIHBhZGRpbmc6IDNweDsNCiAgICBmb250LXNpemU6IDEycHg7'+
        'DQogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICM0NDQ7DQogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkICM0NDQ7DQp9DQoj'+
        'aG9tZWZlZWRjZW50ZXJfcG9wdXAgdWwuc2tpcHBlZF9sb2cgbGkgew0KICAgIGJvcmRlcjogMnB4IHNvbGlkICMxRjFGMUY7DQog'+
        'ICAgbWFyZ2luOiAwcHggMHB4IDRweDsNCiAgICBwYWRkaW5nOiAwcHggMHB4IDBweCAxNnB4Ow0KICAgIHdpZHRoOiBhdXRvICFp'+
        'bXBvcnRhbnQ7DQogICAgYmFja2dyb3VuZC1zaXplOiAxNnB4ICFpbXBvcnRhbnQ7DQogICAgLW1vei1iYWNrZ3JvdW5kLXNpemU6'+
        'IDE2cHggIWltcG9ydGFudDsNCiAgICBtaW4taGVpZ2h0OiAxNnB4ICFpbXBvcnRhbnQ7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9w'+
        'dXAgdWwuc2tpcHBlZF9sb2cgbGkgaW1nIHsNCglmbG9hdDogbGVmdDsNCgl3aWR0aDogMjBweDsNCgloZWlnaHQ6IDIwcHg7DQp9'+
        'DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgdWwuc2tpcHBlZF9sb2cgbGkgcCB7DQogICAgbWFyZ2luOiAxcHggMHB4IDBweCAzcHg7'+
        'DQogICAgaGVpZ2h0OiAyMHB4Ow0KCWxpbmUtaGVpZ2h0OiAyMHB4Ow0KICAgIG92ZXJmbG93LXk6IGhpZGRlbjsNCn0NCiNob21l'+
        'ZmVlZGNlbnRlcl9wb3B1cCAjZmVlZGxpc3RfYm9keSB1bC5mZWVkX2JveCBsaTpmaXJzdC1jaGlsZCB7DQoJYm9yZGVyLXdpZHRo'+
        'OiAwcHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgdWwuZmVlZF9ib3ggbGkgew0KCW1hcmdpbjogMHB4IDBweCA2cHg7DQoJ'+
        'aGVpZ2h0OiA4MHB4Ow0KCW1heC1oZWlnaHQ6IDEwMHB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIHVsLmZlZWRfYm94IGxp'+
        'Lm5ld19wb3N0IHsNCgliYWNrZ3JvdW5kOiB1cmwoJHtiYXNlX3VybH16bWMvbmV3X21lc3NhZ2VfY2FsbG91dF80NXg0NV8wMS5w'+
        'bmcpIG5vLXJlcGVhdCAwcHggMHB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIHVsLmZlZWRfYm94IGRpdi5saV93cmFwcGVy'+
        'IHsNCiAgICBwYWRkaW5nOiA0cHggMTRweCAycHggNHB4Ow0KICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMUYxRjFGOw0K'+
        'ICAgIGJvcmRlci10b3A6IDJweCBzb2xpZCAjMUYxRjFGOw0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwICNhdXRvbW9kZV9ib2R5'+
        'IHVsI2xvZ0xpc3QgZGl2LnNlbGVjdGVkIHsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgYmFja2dyb3VuZC1jb2xvcjog'+
        'IzEyMTIxMjsNCiAgICBib3JkZXItdG9wOiAycHggc29saWQgIzQ0NDsNCiAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgIzQ0'+
        'NDsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCB1bC5mZWVkX2JveCBsaSBpbWcuZmVlZF9pY29uIHsNCglmbG9hdDogbGVmdDsN'+
        'CglkaXNwbGF5OiBibG9jazsNCgl3aWR0aDogNzBweDsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCB1bC5mZWVkX2JveCBsaS5u'+
        'ZXdfcG9zdCBpbWcuZmVlZF9pY29uIHsNCgltYXJnaW46IDE1cHggMCAwIDE1cHg7DQoJd2lkdGg6IDU1cHg7DQp9DQojaG9tZWZl'+
        'ZWRjZW50ZXJfcG9wdXAgdWwuZmVlZF9ib3ggbGkgZGl2LmJ1dHRvbnMgew0KCWZsb2F0OiByaWdodDsNCglmb250LXNpemU6IDEw'+
        'cHg7DQoJZm9udC13ZWlnaHQ6IGJvbGQ7DQoJbWFyZ2luOiAzcHggMHB4IDBweCAxNHB4Ow0KCXRleHQtYWxpZ246IHJpZ2h0Ow0K'+
        'CXdpZHRoOiA3MHB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIHVsLmZlZWRfYm94IGxpIGRpdi5ib2R5IHsNCgltYXJnaW46'+
        'IDBweCA4MHB4Ow0KCWhlaWdodDogNzBweDsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCAjYXV0b21vZGVfYm9keSB1bC5mZWVk'+
        'X2JveCBsaSBkaXYuYm9keSB7DQoJbWFyZ2luLWxlZnQ6IDgwcHg7DQoJaGVpZ2h0OiA3MHB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVy'+
        'X3BvcHVwIHVsLmZlZWRfYm94IGxpIGg0IHsNCglmb250LXNpemU6IDE0cHg7DQoJbGluZS1oZWlnaHQ6IDE4cHg7DQoJbWFyZ2lu'+
        'LWJvdHRvbTogNHB4Ow0KCXBhZGRpbmctdG9wOiAycHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgdWwuZmVlZF9ib3ggbGkg'+
        'cCB7DQoJZm9udC1zaXplOiAxMnB4Ow0KCWxpbmUtaGVpZ2h0OiAxNXB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIHVsLmZl'+
        'ZWRfYm94IGxpIGRpdi5idXR0b25zIGEuc2V4eV9idXR0b25fbmV3IHsNCiAgICBtaW4td2lkdGg6IDYycHg7DQoJbWFyZ2luLWJv'+
        'dHRvbTogNnB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIHVsLmZlZWRfYm94IGxpIGRpdi5idXR0b25zIGEuaWdub3JlIHsN'+
        'Cgl0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOw0KfQ0KI2ZlZWRfY2VudGVyX2hlYWRlciBwLCAjaG9tZWZlZWRjZW50ZXJfcG9w'+
        'dXAgdWwsICNob21lZmVlZGNlbnRlcl9wb3B1cCBsaSwgI2hvbWVmZWVkY2VudGVyX3BvcHVwIGRsLCAjaG9tZWZlZWRjZW50ZXJf'+
        'cG9wdXAgZHQsICNob21lZmVlZGNlbnRlcl9wb3B1cCBkZCwgI2hvbWVmZWVkY2VudGVyX3BvcHVwIGgyLCAjaG9tZWZlZWRjZW50'+
        'ZXJfcG9wdXAgaDMsICNob21lZmVlZGNlbnRlcl9wb3B1cCBoNCwgI2hvbWVmZWVkY2VudGVyX3BvcHVwIHAgew0KCW1hcmdpbjog'+
        'MHB4Ow0KCXBhZGRpbmc6IDBweDsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCAuc2VsZWN0X3RhYiB7DQoJYm9yZGVyOiAxcHgg'+
        'c29saWQgIzRGNEY0RjsNCglmbG9hdDogbGVmdDsNCgltaW4taGVpZ2h0OiAxNDBweDsNCgltYXJnaW46IDJweDsNCglvdmVyZmxv'+
        'dzogYXV0bzsNCglwYWRkaW5nOiA1cHg7DQoJdGV4dC1hbGlnbjogbGVmdDsNCgl3aWR0aDogMjQwcHg7DQp9DQojaG9tZWZlZWRj'+
        'ZW50ZXJfcG9wdXAgLnNlbGVjdF90YWIgZGl2IHsNCglib3JkZXI6IDFweCBzb2xpZCAjMkYyRjJGOw0KCW92ZXJmbG93OiBoaWRk'+
        'ZW47DQoJcGFkZGluZzogMHB4IDJweCAycHggNXB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIC5zZWxlY3RfdGFiIGRpdi5z'+
        'ZWxlY3RlZCB7DQoJYm9yZGVyOiAxcHggc29saWQgeWVsbG93Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIC5zZWxlY3RfdGFi'+
        'IGRpdiBpbnB1dCB7DQoJZmxvYXQ6IGxlZnQ7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgLnNlbGVjdF90YWIgZGl2IHAgew0K'+
        'CWZsb2F0OiBsZWZ0Ow0KCWN1cnNvcjogcG9pbnRlcjsNCgl3aWR0aDogODYlOw0KCW92ZXJmbG93OiBoaWRkZW47DQp9DQojaG9t'+
        'ZWZlZWRjZW50ZXJfcG9wdXAgLmNvbmZpZ190YWIgew0KCWZsb2F0OiBsZWZ0Ow0KCXBhZGRpbmc6IDBweCAxMHB4Ow0KCXRleHQt'+
        'YWxpZ246IGxlZnQ7DQoJd2lkdGg6IDQyMHB4Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIC5zYXZlX2NvbmZpZyB7DQoJY2xl'+
        'YXI6IGJvdGg7DQoJcGFkZGluZy10b3A6IDE2cHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgI2ZlZWRsaXN0X2JvZHksIA0K'+
        'I2hvbWVmZWVkY2VudGVyX3BvcHVwICNhdXRvbW9kZV9ib2R5ICB7DQoJdGV4dC1hbGlnbjogbGVmdDsNCn0NCiNob21lZmVlZGNl'+
        'bnRlcl9wb3B1cCAjcGFuZWxfY29udGFpbmVyIHsNCgliYWNrZ3JvdW5kOiAjMTExIHVybCgke2Jhc2VfdXJsfXptYy90YWJzX2Jn'+
        'XzF4NDVfMDEuZ2lmKSByZXBlYXQteCAwcHggMTAwJTsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7'+
        'DQogICAgei1pbmRleDogMTA7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgI3BhbmVsX2NvbnRhaW5lciAuc2VhcmNoX2JveCB7'+
        'DQoJZmxvYXQ6IGxlZnQ7DQoJbWFyZ2luOiAwcHggNXB4Ow0KCXRleHQtYWxpZ246IGxlZnQ7DQoJd2lkdGg6IDM3MHB4Ow0KfQ0K'+
        'I2hvbWVmZWVkY2VudGVyX3BvcHVwICNwYW5lbF9jb250YWluZXIgLmNvbnRyb2xfYm94IHsNCglmbG9hdDogcmlnaHQ7DQoJbWFy'+
        'Z2luOiAwcHggNXB4Ow0KCXRleHQtYWxpZ246IGNlbnRlcjsNCgl3aWR0aDogMzQwcHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9w'+
        'dXAgI3N0YXR1c19wYW5lbCwgDQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgI2NvbnRyb2xfcGFuZWwgIHsNCgloZWlnaHQ6IDM1cHg7'+
        'DQogICAgd2lkdGg6IDEwMCU7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgI2NvbmZpZ19wYW5lbCB7DQoJaGVpZ2h0OiAyNTBw'+
        'eDsNCgltYXJnaW46IDVweDsNCiAgICB3aWR0aDogMTAwJTsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCAjbWluaXBvcHVwX292'+
        'ZXJsYXkgew0KICAgIGRpc3BsYXk6IG5vbmU7DQogICAgd2lkdGg6IDEwMCU7DQogICAgaGVpZ2h0OiA3NTBweDsNCiAgICBwb3Np'+
        'dGlvbjogYWJzb2x1dGU7DQogICAgYmFja2dyb3VuZC1jb2xvcjogYmxhY2s7DQogICAgb3BhY2l0eTogMC41Ow0KICAgIHotaW5k'+
        'ZXg6IDU7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgI21pbmlwb3B1cF9jb250ZW50IGNlbnRlciB7DQogICAgaGVpZ2h0OiAz'+
        'MHB4Ow0KICAgIGJvcmRlci1ib3R0b206IDFweCBkb3R0ZWQgIzMzMzsNCiAgICBtYXJnaW4tYm90dG9tOiAxNXB4Ow0KICAgIGZv'+
        'bnQtc2l6ZTogMThweDsNCiAgICBmb250LXdlaWdodDogYm9sZDsNCiAgICBjb2xvcjogIzk4OTg5ODsNCn0NCiNob21lZmVlZGNl'+
        'bnRlcl9wb3B1cCAjbWluaXBvcHVwX2NvbnRlbnQgLmZiX2ZyaWVuZGxpc3Qgew0KICAgIGhlaWdodDogMjAwcHg7DQogICAgb3Zl'+
        'cmZsb3c6IGF1dG87DQogICAgbWFyZ2luOiAwcHggMTBweCA1cHg7DQogICAgYm9yZGVyOiAycHggc29saWQgIzQ0NDsNCiAgICBw'+
        'YWRkaW5nOiA1cHg7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgLndhcmxvb3RfYnV0dG9ucyB7DQogICAgdGV4dC1hbGlnbjog'+
        'cmlnaHQ7DQp9DQojaG9tZWZlZWRjZW50ZXJfcG9wdXAgLndhcmxvb3RfYnV0dG9ucyBhIHsNCiAgICBtYXJnaW4tbGVmdDogNXB4'+
        'Ow0KfQ0KI2hvbWVmZWVkY2VudGVyX3BvcHVwIC51aS1maWx0ZXJsaXN0IGRpdi51aS10b3Agew0KICAgIGNsZWFyOiBib3RoOw0K'+
        'ICAgIG1hcmdpbi1ib3R0b206IDNweDsNCiAgICBsaW5lLWhlaWdodDogMjBweDsNCn0NCiNob21lZmVlZGNlbnRlcl9wb3B1cCAu'+
        'dWktZmlsdGVybGlzdCBkaXYudWktdG9wIHNwYW4uY2hlY2tib3ggew0KICAgIGxpbmUtaGVpZ2h0OiAyNHB4Ow0KfQ0KI2hvbWVm'+
        'ZWVkY2VudGVyX3BvcHVwIC51aS1maWx0ZXJsaXN0ID4gc2VsZWN0IHsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBoZWlnaHQ6IDE1'+
        'MHB4Ow0KfQ0K', 
        {base_url: global.zGraphicsURL}
    );
    
    // make sure we have permissions and Initialize
    facebook.needAppPermission('read_stream,offline_access', function(success) {
        if (success === true) {
            options.load(Initialize);
        } else {
            popupElt.destroy();
        }
    });
}